# Лабораторная работа №2

Задача - расчет показателей временной области вариабельности сердечного ритма (ВСР)
из последовательности RR-интервалов.
Данные показатели отражают функциональное состояние человека.
Подробнее интерпретация и возможности использования данных показателей см. в 
[документе](http://www.vestar.ru/atts/2581/258101.pdf)

Ниже в описании `NN` тождественно `RR`, `NN` - это нормальные RR-интервалы, в пределах 50 мс.

## Дано

1. 1 файл в формате `.txt` с последовательностью RR-интервалов в мс, полученные через расчеты, 
выполняемые в лабораторной работе 1.
2. Необходимо рассчитать для каждой последовательности диагностические показатели временной области с точностью 2 знака после запятой:
   - `SDNN` — стандартное отклонение интервалов `NN`. 
      `SDNN` является мерой изменчивости частоты сердечных сокращений. 
      `SDNN` отражает все циклические компоненты, ответственные за изменчивость в период записи, 
      поэтому он представляет общую изменчивость.
   - `RMSSD` — «среднеквадратичное значение последовательных различий», 
      квадратный корень из среднего значения 
      квадратов последовательных различий (разностей) между соседними `NN`.
   - `SDSD` — «стандартное отклонение последовательных различий», 
      стандартное отклонение последовательных 
      различий (разностей) между соседними `NN`.
   - `NN50` — количество пар последовательных `NN`, которые отличаются более чем на 50 мс.
   - `pNN50` — доля `NN50`, деленная на общее количество `NN`.
   - `NN20` — количество пар последовательных `NN`, которые отличаются более чем на 20 мс.
   - `pNN20` — доля `NN20`, деленная на общее количество `NN`.


## Шаг 0.1. Подготовка. Настройте репозиторий для работы над второй лабораторной работой

1. Убедитесь, что вы добавили в коллабораторы к своему репозиторию менторов. Инструкция по добавлению коллабораторов
   может быть найдена по [по ссылке](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-access-to-your-personal-repositories/inviting-collaborators-to-a-personal-repository). 
   Список логинов для добавления:
   
   - `AlexeyChikhachev`
   - `abakhchina`
   - `demid5111`

4. Убедитесь, что ваш репозиторий содержит тесты для второй лабораторной работы. Они должны быть представлены
   несколькими файлами `test_*.py` в папке `lab_2/tests/`. Если их там нет, обязательно сообщите об этом ментору. 
   Он обновит ваш репозиторий. Если вы проходите данную дисциплину самостоятельно, без посещения онлайн занятий, 
   вам надо обновить репозиторий
   самостоятельно с помощью команд, вроде `git merge`, либо скопировать тесты из основного репозитория к себе.

5. Добавьте в файл `automation/labs.txt` указание о включении тестов для второй лабораторной работы. Он должен теперь 
   выглядеть так:

   ```bash
   # automation/labs.txt
   1 2
   ```

6. Можете переходить к следующему шагу.


## Шаг 0.2. Подготовка. Скачать файл с последовательностью RR-интервалов и положить в каталог

В Лабораторной работе №1 вы рассчитывали RR интервалы из ECG сигнала. Итоговая последовательность RR-интервалов
представлена в виде текстового файла. Вам необходимо скачать пример такого файла
из папки на GDrive: [ссылка](https://drive.google.com/drive/folders/1RkT5XnM7kEpnzYP8gPuPStZRIuONQIzv?usp=sharing).

> Внимание: скачать нужно только файл `participant_28_baseline_rr.txt`
Нужно создать каталог `lab_2/data` и поместить туда скачанный файл. В итоге у вас 
должна получиться следующая структура каталогов:

```
|-- lab_1
    |-- data
        |-- participant_28_baseline_raw.txt
    |-- __init__.py
    |-- main.py
|-- lab_2
    |-- data
        |-- participant_28_baseline_rr.txt
    |-- __init__.py
    |-- main.py
|-- lab 3
```

## Шаг 1. Расчет `SDNN` для последовательности RR-интервалов

Функция принимает на вход список RR-интервалов в формате вещественных чисел.
Функция возвращает значение `SDNN`, рассчитанное по формуле `SDNN`:

<!-- \sqrt{\frac{1}{N}\sum_{i=1}^{N}(RR_{i} - RR_{mean})^{2}} -->
<img src="https://latex.codecogs.com/svg.image?\sqrt{\frac{1}{N}\sum_{i=1}^{N}(RR_{i}&space;-&space;RR_{mean})^{2}}" title="https://latex.codecogs.com/svg.image?\sqrt{\frac{1}{N}\sum_{i=1}^{N}(RR_{i} - RR_{mean})^{2}}" />

, где `N` - количество RR-интервалов в ряду, 
`RR_mean` - среднее арифметическое RR-интервалов в ряду

**Входы (аргументы функции)**: сигнал в виде списка чисел типа `float`
**Выходы (возвращаемое значение функции)**: число типа `float`, то есть искомое значение `SDNN` для 
заданной последовательности RR-интервалов

Если на вход подаются некорректные значения, возвращается `None`.


**Объявление функции:** 

```py
def calculate_sdnn(signal: list) -> float:
    pass
```

## Шаг 2. Расчет `RMSSD` для последовательности RR-интервалов

Функция принимает на вход список RR-интервалов в формате вещественных чисел.
Функция возвращает значение `RMSSD`, рассчитанное по формуле `RMSSD`:

<!-- \sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(RR_{i} - RR_{i+1})^{2}} -->
<img src="https://latex.codecogs.com/svg.image?\sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(RR_{i}&space;-&space;RR_{i&plus;1})^{2}}&space;" title="https://latex.codecogs.com/svg.image?\sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(RR_{i} - RR_{i+1})^{2}} " />


, где `N` - количество RR-интервалов в ряду

**Входы (аргументы функции)**: сигнал в виде списка чисел типа `float`
**Выходы (возвращаемое значение функции)**: число типа `float`, то есть искомое значение `RMSSD` для 
заданной последовательности RR-интервалов

Если на вход подаются некорректные значения, возвращается `None`.

**Объявление функции:** 

```py
def calculate_rmssd(signal: list) -> float:
    pass
```


## Шаг 3. Расчет `SDSD` для последовательности RR-интервалов

Функция принимает на вход список RR-интервалов в формате вещественных чисел.
Функция возвращает значение `SDSD`, рассчитанное по формуле `SDSD`:

<!-- \sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(RRd_{i} - RRd_{mean})^{2}} -->
<img src="https://latex.codecogs.com/svg.image?\sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(RRd_{i}&space;-&space;RRd_{mean})^{2}}&space;" title="https://latex.codecogs.com/svg.image?\sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(RRd_{i} - RRd_{mean})^{2}} " />
, где n - количество RR-интервалов в ряду
<!-- RRd = RR_{i} - RR_{i+1}  -->
<img src="https://latex.codecogs.com/svg.image?RRd&space;=&space;RR_{i}&space;-&space;RR_{i&plus;1}&space;" title="https://latex.codecogs.com/svg.image?RRd = RR_{i} - RR_{i+1} " />

**Входы (аргументы функции)**: сигнал в виде списка чисел типа `float`
**Выходы (возвращаемое значение функции)**: число типа `float`, то есть искомое значение `SDSD` для 
заданной последовательности RR-интервалов

Если на вход подаются некорректные значения, возвращается `None`.

**Объявление функции:** 

```py
def calculate_sdsd(signal: list) -> float:
    pass
```

## Шаг 4. Расчет `NN` и `pNN` показателей для последовательности RR-интервалов

Функция принимает на вход список RR-интервалов в формате вещественных чисел и 
параметр `m` - порог для разности последовательных пар RR-интервалов.

Функция возвращает значение `NN` по формуле:
<!-- NN = \left\|RRd\leqslant m \right\| 
pNN = \frac{\left\|RRd\leqslant m \right\|}{n}-->
<img src="https://latex.codecogs.com/png.image?\dpi{110}&space;NN&space;=&space;\left\|RRd\leqslant&space;m&space;\right\|" title="NN = \left\|RRd\leqslant m \right\|" />

и значение `pNN` по формуле:
<img src="https://latex.codecogs.com/png.image?\dpi{110}&space;pNN&space;=&space;\frac{\left\|RRd\leqslant&space;m&space;\right\|}{n}" title="pNN = \frac{\left\|RRd\leqslant m \right\|}{n}" />
, где `n` - количество RR-интервалов в ряду

<img src="https://latex.codecogs.com/png.image?\dpi{110}&space;RRd&space;=&space;RR_{i}&space;-&space;RR_{i&plus;1}&space;" title="RRd = RR_{i} - RR_{i+1} " />

**Входы (аргументы функции)**: 
сигнал в виде списка чисел типа `float`,
значение порога для оценки разностей последовательных пар RR-интервалов типа `int`
**Выходы (возвращаемое значение функции)**: числа типа `float`, то есть искомые значение `NN` и `pNN` для 
заданной последовательности RR-интервалов в виде списка (типа `list`), в котором значением под индексом 0
является рассчитанный `NN`, а значением под индексом 1 рассчитанный `pNN`.

Если на вход подаются некорректные значения, возвращается `None`.


**Объявление функции:** 

```py
def calculate_nn_pnn(signal: list, threshold: int) -> float:
    pass
```

> Внимание: показатели `NN` и `pNN` рассчитываются для двух порогов: 50 и 20.

**Пример вызова:**

```python
nn, pnn = calculate_nn_pnn(signal, 20)
print(nn)  # 185
print(pnn)  # 0.645
```

## Шаг 5. Сохранение рассчитанных показателей в файл

Функция принимает на вход значения рассчитанных показателей в формате словаря

```py
hrv_characteristics = {
    'SDNN': 0,
    'RMSSD': 0,
    'SDSD': 0,
    'NN50': 0, 
    'pNN50': 0,
    'NN20': 0, 
    'pNN20': 0
}
```
и путь до нового файла.

Функция создаёт файл с таблицей рассчитанных показателей в директории компьютера 
по указанному пути. Имя файла состоит из имени входного файла без суффикса `_rr`, но
с суффиксом `_hrv.txt`. Например, для входного файла `participant_28_baseline_rr.txt`
должен получиться файл `participant_28_baseline_hrv.txt`.

**Входы (аргументы функции)**: 
рассчитанные значения показателей ВСР, собранные в объект типа `dict`,
путь сохранения файла - отчёта типа `str`
**Выходы (возвращаемое значение функции)**: `None`

Если на вход подаются некорректные значения, возвращается `-1`.

**Объявление функции:** 

```py
def save_hrv_in_file(hrv_characteristics: dict, path: str) -> float:
    pass
```

**Пример вызова:**

```python
save_hrv_in_file(hrv_characteristics, './data/participant_28_baseline_hrv.txt')
```

> Внимание: проверьте содержимое файла после вызова функции и сохранения результатов.

**Пример содержимого файла: `participant_28_baseline_hrv.txt`**

```
SDNN	76.14
RMSSD	57.44
SDSD	57.54
NN50	185
pNN50	0.64
NN20	185
pNN20	0.64
```
